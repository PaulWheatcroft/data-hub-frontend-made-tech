{% extends "./_layouts/view.njk" %}

{% set companyLink %}
  <a href="/viewcompanyresult/{{ values.company.id }}">{{ values.company.name }}</a>
{% endset %}
{% set contactLink %}
  <a href="/contacts/{{ values.contact.id }}">{{ values.contact.name }}</a>
{% endset %}

{% block main_grid_right_column %}
  {% if not order.editable %}
    <div class="c-messages__item c-messages__item--info">
      <p>You cannot edit the order whilst a quote is awaiting acceptance.</p>
      <p>You must <a href="quote">cancel the quote</a> to edit the order.</p>
    </div>
  {% endif %}

  {{ AnswersSummary({
    heading: 'Client details',
    actions: [{
      url: 'edit/client-details' if order.editable
    }],
    items: [{
      label: 'Company',
      value: companyLink
    }, {
      label: 'Contact',
      value: contactLink
    }]
  }) }}

  {{ AnswersSummary({
    heading: 'Market of interest',
    items: [{
      label: 'Primary market',
      value: values.primary_market.name
    }]
  }) }}

  {{ AnswersSummary({
    heading: 'International Trade Advisers (ITAs)',
    actions: [{
      url: 'edit/subscribers' if order.editable,
      label: 'Add or remove'
    }],
    items: values.subscribers | map('name') if values.subscribers.length else ['None selected']
  }) }}

  {% call AnswersSummary({
    heading: 'Post advisers',
    actions: [{
      url: 'edit/assignees' if order.editable,
      label: 'Add or remove'
    }, {
      url: 'edit/assignee-time' if values.assignees.length and order.editable,
      label: 'Edit time'
    }]
  }) %}
    <tbody>
      {% for assignee in values.assignees %}
        <tr>
          <th class="c-answers-summary__title" scope="row">
            {{ assignee.adviser.name }} {{ '(you)' if assignee.adviser.id === user.id }}
            {% if assignee.is_lead %}
              <span class="c-badge">Lead adviser</span>
            {% endif %}
          </th>
          <td class="c-answers-summary__content c-answers-summary__control">
            {% if not assignee.is_lead %}
              {% call Form ({
                action: 'edit/lead-assignee',
                hideFormActions: true,
                hiddenFields: {
                  adviserId: assignee.adviser.id,
                  orderId: order.id
                }
              }) %}
                <button type="submit" class="button button--link button--compact">Set as lead adviser</button>
              {% endcall %}
            {% endif %}
          </td>
          <td class="c-answers-summary__content c-answers-summary__content--number">
            {{ assignee.estimated_time  | humanizeDuration if assignee.estimated_time else 'No time estimated' }}
          </td>
        </tr>
      {% else %}
        <tr>
          <td class="c-answers-summary__content" colspan="3">None selected</td>
        </tr>
      {% endfor %}
    </tbody>

    {% if values.estimatedTimeSum and values.assignees.length %}
      <tfoot>
        <tr>
          <td class="c-answers-summary__footer" colspan="3">
            <span class="c-answers-summary__footer-value">{{ values.estimatedTimeSum | humanizeDuration }}</span> total estimated time
          </td>
        </tr>
      </tfoot>
    {% endif %}
  {% endcall %}

  {{ AnswersSummary({
    heading: 'Work description',
    actions: [{
      url: 'edit/work-description' if order.editable
    }],
    items: [{
      label: 'Delivery date',
      value: values.delivery_date | formatDate if values.delivery_date else 'Not set'
    }, {
      label: 'Service type' | pluralise(values.service_types.length),
      value: values.service_types | map('name') | join(', ') if values.service_types.length else 'None added'
    }, {
      label: 'Sector',
      value: values.sector.name or 'Not selected'
    }, {
      label: 'Description of the activity',
      value: values.description or 'Not added'
    }, {
      label: 'Contacts not to approach',
      value: values.contacts_not_to_approach
    }, {
      label: 'Existing representatives',
      value: values.existing_agents
    }, {
      label: 'Permission to approach contacts',
      value: values.permission_to_approach_contacts
    }, {
      label: 'Production information',
      value: values.product_info
    }, {
      label: 'Further information',
      value: values.further_info
    }]
  }) }}

  {% if values.vat_verified === true %}
    {% set verifiedState = translate('fields.vat_verified.options.valid') %}
  {% elif values.vat_verified === false %}
    {% set verifiedState = translate('fields.vat_verified.options.invalid') %}
  {% else %}
    {% set verifiedState = translate('fields.vat_verified.options.unverified') %}
  {% endif %}

  {{ AnswersSummary({
    heading: 'Quote and payment details',
    actions: [{
      url: 'edit/payment' if order.editable
    }],
    items: [{
      label: 'VAT category',
      value: translate('fields.vat_status.options.' + values.vat_status) if values.vat_status else 'Not set'
    }, {
      label: 'VAT number',
      value: values.vat_number + ' (' + verifiedState + ')' if values.vat_number
    }, {
      label: 'Purchase Order (PO) number',
      value: values.po_number or 'Not set'
    }]
  }) }}

{% endblock %}
